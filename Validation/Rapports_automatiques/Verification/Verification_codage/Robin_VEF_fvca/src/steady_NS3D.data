# PARALLEL OK  #
Dimension 3
Pb_hydraulique pb

Domaine dom

# BEGIN MESH #
Read_MED { domain dom mesh dom file  ../../../../coarse_mesh3D.med }
$raf
# END MESH #

# BEGIN PARTITION
Partition dom
{
    Partition_tool metis { nb_parts 4  }
    Larg_joint 2
    zones_name DOM
}
End
END PARTITION #

# BEGIN SCATTER
Scatter DOM.Zones dom
END SCATTER #

$dis

Schema_Euler_implicite sch
Lire sch
{
    tinit 0
    tmax 1
    # dt_min $dt #
    dt_max $dt
    dt_impr 1e1
    facsec 1
    facsec_max 500
    solveur implicite { solveur gmres { diag nb_it_max 3 seuil 1e-12 impr } }
}

Associate  pb dom
Associate  pb sch
Discretize pb dis

Read pb
{

    fluide_incompressible {
        mu  Champ_Uniforme 1 1
        rho Champ_Uniforme 1 1
    }


    Navier_Stokes_standard
    {
        methode_calcul_pression_initiale avec_sources_et_operateurs
        solveur_pression petsc cholesky { }
        convection { muscl }
        diffusion  { }
        initial_conditions
        {
            vitesse champ_fonc_xyz dom 3 y-z z-x x-y
        }
        Conditions_limites	{
            Gauche		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 3 y-z z-x x-y
            Bas		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 3 y-z z-x x-y
            Droite	Robin_VEF {
                alpha 3
                beta 4
                champ_front_normal_et_tangentiel_robin champ_front_fonc_txyz 4 -3*x^2+3*x*y+3*x*z-3*y^2+3*y*z+y-3*z^2-z-3*(y-z)^2+0.75 0 -x+z-4*(-x+z)*(y-z)-4 x-y-4*(x-y)*(y-z)+4
            }

            Haut		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 3 y-z z-x x-y
            Derriere	frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 3 y-z z-x x-y
            Devant		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 3 y-z z-x x-y
        }
    }

    Postraitement
    {
        Definition_champs	{
            # euclidian_norm_norme_uex = norme L2 de la norme de uex (valeur calculee sur le maillage) #
            # euclidian_norm_norme_uex	reduction_0D	{
            methode euclidian_norm
            sources	{
                transformation	{
                    methode norme
                    localisation FACES
                    sources	{
                        transformation	{
                            methode vecteur
                            expression 3 y-z z-x x-y
                            nom_source uex
                            localisation FACES
                        }
                    }
                }
            }
        } #
        # euclidian_norm_norme_uex = norme L2 de la norme de uex (valeur exacte) #
        euclidian_norm_norme_uex	transformation	{
            methode formule expression 1 valeur_exacte*euclidian_norm_1
            localisation FACES
            sources	{
                transformation	{
                    methode formule
                    expression 1 sqrt(2)/2
                    localisation FACES
                    nom_source valeur_exacte
                } ,
                reduction_0D	{
                    methode euclidian_norm
                    nom_source euclidian_norm_1
                    source transformation	{
                        methode formule expression 1 1
                        localisation FACES
                    }
                }
            }
        }
        # Norme L2 de la norme de u-uex #
        euclidian_norm_norme_u_uex	reduction_0D	{
            methode euclidian_norm
            sources	{
                transformation	{
                    # norme de u-uex #
                    methode norme
                    localisation FACES
                    sources	{
                        # u-uex #
                        transformation	{
                            methode formule expression 1 u-uex
                            nom_source u_uex
                            localisation FACES
                            sources	{
                                refChamp { Pb_champ pb vitesse nom_source u } ,
                                # expression de uex #
                                transformation	{
                                    methode vecteur
                                    expression 3 y-z z-x x-y
                                    nom_source uex
                                    localisation FACES
                                }
                            }
                        }
                    }
                }
            }
        }
        # erru = euclidian_norm_norme_u_uex / euclidian_norm_norme_uex #
        erru			transformation	{
            methode formule
            expression 1 euclidian_norm_norme_u_uex/euclidian_norm_norme_uex
            sources_reference { euclidian_norm_norme_u_uex , euclidian_norm_norme_uex }
        }
        euclidian_norm_pex_elem	transformation	{
            methode formule expression 1 valeur_exacte*euclidian_norm_1
            localisation elem
            sources	{
                transformation	{
                    methode formule
                    expression 1 sqrt(15)/20
                    localisation elem
                    nom_source valeur_exacte
                } ,
                reduction_0D	{
                    methode euclidian_norm
                    nom_source euclidian_norm_1
                    source transformation	{
                        methode formule expression 1 1
                        localisation elem
                    }
                }
            }
        }
        euclidian_norm_p_pex_elem	reduction_0D	{
            methode euclidian_norm
            source transformation	{
                methode formule expression 1 pelem-pmoy-pex
                localisation elem
                sources	{
                    interpolation	{
                        localisation elem
                        nom_source pelem
                        sources {  refChamp { Pb_champ pb pression } }
                    } ,
                    # integrale de p #
                    reduction_0D	{
                        methode moyenne
                        nom_source pmoy
                        source interpolation	{
                            localisation elem
                            source refChamp { Pb_champ pb pression }
                        }
                    } ,
                    # expression de pex #
                    transformation	{
                        methode formule
                        expression 1  x^2+y^2+z^2-x*y-x*z-y*z-1./4
                        nom_source pex
                        localisation elem
                    }
                }
            }
        }
        # errp = euclidian_norm_p_pex / euclidian_norm_pex #
        errp_elem		transformation	{
            methode formule
            expression 1 euclidian_norm_p_pex_elem/euclidian_norm_pex_elem
            sources_reference { euclidian_norm_p_pex_elem , euclidian_norm_pex_elem }
        }
        # errdivu = norme L2 de la divergence de u #
        euclidian_norm_1		reduction_0D	{
            methode euclidian_norm
            source transformation	{
                methode formule
                expression 1 1
                localisation elem
            }
        }
        euclidian_norm_divu		reduction_0D	{
            methode euclidian_norm
            sources	{
                interpolation {
                    localisation elem
                    sources {
                        # divergence u #
                        divergence	{
                            source refChamp { Pb_champ pb vitesse }
                        }
                    }
                }
            }
        }
        errdivu			transformation	{
            methode formule
            expression 1 euclidian_norm_divu/euclidian_norm_1
            localisation elem
            sources_reference { euclidian_norm_divu , euclidian_norm_1 }
        }
    }
    Sondes			{
        erru				erru		periode 5e-2 numero_elem_sur_maitre 0
        errp_elem			errp_elem	periode 5e-2 numero_elem_sur_maitre 0
        errdivu				errdivu		periode 5e-2 numero_elem_sur_maitre 0
    }
    Format single_lata
    Champs binaire dt_post 1e6
    {
        pression ELEM
        vitesse ELEM
    }
}
sauvegarde formatte Cas.sauv
}

Resoudre pb
Fin
