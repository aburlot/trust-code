#!/bin/bash
# Outil de NR des performances par analyse des .TU machine specifique
check()
{
   for ligne in dt total
   do
      if [ $ligne = "dt" ]
      then
         # Time per step
         ref=`TU.sh $1.TU.ref_$2 -dt`
         new=`TU.sh $1.TU -dt`
      elif [ $ligne = "total" ]
      then
         # Total time
         ref=`TU.sh $1.TU.ref_$2 -total`
         new=`TU.sh $1.TU -total`
      fi
      echo $ref $new | awk '// {err=2*($2-$1)/($1+$2);OK=(err>0.05?0:(err>-0.025?1:2));exit OK}' # On verifie qu'on ne depasse pas +5% de la performance
      OK=$?
      ecart=`echo $ref $new | awk '// {printf("%2.1f%\n",-2*($1-$2)/($1+$2)*100)}'`
      if [ $OK = 0 ]
      then
         sdiff -w 200 $1.TU.ref_$2 $1.TU
         echo "================================"
         echo "Performance is KO ($ecart) $new s > $ref s (reference) for $1 on $2"
         echo "================================"
      elif [ $OK = 1 ]
      then
         echo "Performance is OK ($ecart) $new s - $ref s (reference) for $1 on $2"
      else
         echo "Performance reference isn't up to date ($ecart) $new s < $ref s (reference) for $1 on $2"
         UPDATE_REFERENCE=1
      fi
      if [ "$UPDATE_REFERENCE" = 1 ]
      then
         if [ "$project_directory" != "" ]
         then
            cp `pwd`/$1.TU `find $project_directory/tests -name $1.TU.ref_$2`
         else
            cp `pwd`/$1.TU `find $TRUST_ROOT/tests -name $1.TU.ref_$2`
         fi
         echo "$1.TU.ref_$2" updated !      
      fi
      [ $OK = 0 ] && exit -1
      exit 0
   done   
}
# ToDo: prevoir dans le script trust un lock avant le lancement
# On compare les performances avec le fichier jdd.TU.ref_$HOST_BUILD
# Si le fichier existe
# Si le binaire est bien opt (et pas debug ou semi_opt)
if [ ! -f $1.TU.ref_$HOST_BUILD ] || [ ${exec%_semi_opt} != $exec ] || [ ${exec%_opt} = $exec ]
then
   exit 0
else
   check $1 $HOST_BUILD
fi

