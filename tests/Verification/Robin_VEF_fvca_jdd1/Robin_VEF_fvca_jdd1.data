# PARALLEL OK #
dimension 2
Pb_hydraulique pb
Domaine dom

# BEGIN MESH #
Read_MED { domain dom mesh mesh2D file  coarse_mesh_square.med }

# END MESH #

# BEGIN PARTITION
Partition dom
{
    partitionneur metis { Nb_parts 4 }
    Larg_joint 2
    zones_name DOM
}
End
END PARTITION #

# BEGIN SCATTER
Scatter DOM.Zones dom
END SCATTER #

VEFPreP1b dis Read dis { P0 }

Schema_Euler_implicite sch
Lire sch
{
    tinit 0
	nb_pas_dt_max 3
    # dt_min 0.0144 #
    dt_max 0.0144
    facsec 1e30
    facsec_max 1e30
    solveur implicite { solveur gmres { diag nb_it_max 3 seuil 1e-12 impr } }
    seuil_statio 1e-8
}

Associate  pb dom
Associate  pb sch
Discretize pb dis

Read pb
{

    fluide_incompressible {
        mu  Champ_Uniforme 1 1
        rho Champ_Uniforme 1 1
    }


    Navier_Stokes_standard
    {
        methode_calcul_pression_initiale avec_sources_et_operateurs
        solveur_pression petsc cholesky { }
        convection { negligeable }
        diffusion  { }
        sources
        {
            source_qdm champ_fonc_xyz dom 2 (256*(x^2*(x-1)^2*(12*y-6)+y*(y-1)*(2*y-1)*(12*x^2-12*x+2))+(y-1/2)) (-256*(y^2*(y-1)^2*(12*x-6)+x*(x-1)*(2*x-1)*(12*y^2-12*y+2))+(x-1/2))
        }
        initial_conditions { vitesse Champ_Fonc_xyz dom 2 256*x*x*(1-x)*(x-1)*y*(y-1)*(2*y-1)  256*y*y*(1-y)*(1-y)*x*(x-1)*(2*x-1) }
        Conditions_limites	{
            gauche		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 2 256*x*x*(1-x)*(x-1)*y*(y-1)*(2*y-1)  256*y*y*(1-y)*(1-y)*x*(x-1)*(2*x-1)
            droit		frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 2 256*x*x*(1-x)*(x-1)*y*(y-1)*(2*y-1)  256*y*y*(1-y)*(1-y)*x*(x-1)*(2*x-1)
            haut		Robin_VEF {
                alpha 0.01
                beta 0.04
                champ_front_normal_et_tangentiel_robin champ_front_fonc_xyz 2 256*x*y^2*(x-1)*(2*x-1)*(y-1)^2+2.56*x*y^2*(x-1)*(2*x-1)*(2*y-2)+5.12*x*y*(x-1)*(2*x-1)*(y-1)^2-0.01*(x-0.5)*(y-0.5) 256*x^2*y*(x-1)^2*(y-1)*(2*y-1)+20.48*x^2*y*(x-1)^2*(y-1)+10.24*x^2*y*(x-1)^2*(2*y-1)+10.24*x^2*(x-1)^2*(y-1)*(2*y-1)
            }
            bas			frontiere_ouverte_vitesse_imposee champ_front_fonc_xyz 2 256*x*x*(1-x)*(x-1)*y*(y-1)*(2*y-1)  256*y*y*(1-y)*(1-y)*x*(x-1)*(2*x-1)
        }
    }


    Postraitement
    {
        Definition_champs	{
            # euclidian_norm_norme_uex = norme L2 de la norme de uex (valeur exacte) #
            euclidian_norm_norme_uex	transformation	{
                methode formule expression 1 valeur_exacte*euclidian_norm_1
                localisation FACES
                sources	{
                    transformation	{
                        methode formule
                        expression 1 128*sqrt(6)/315
                        localisation FACES
                        nom_source valeur_exacte
                    } ,
                    reduction_0D	{
                        methode euclidian_norm
                        nom_source euclidian_norm_1
                        source transformation	{
                            methode formule expression 1 1
                            localisation FACES
                        }
                    }
                }
            }
            # Norme L2 de la norme de u-uex #
            euclidian_norm_norme_u_uex	reduction_0D	{
                methode euclidian_norm
                sources	{
                    transformation	{
                        # norme de u-uex #
                        methode norme
                        localisation FACES
                        sources	{
                            # u-uex #
                            transformation	{
                                methode formule expression 1 u-uex
                                nom_source u_uex
                                localisation FACES
                                sources	{
                                    refChamp { Pb_champ pb vitesse nom_source u } ,
                                    # expression de uex #
                                    transformation	{
                                        methode vecteur
                                        expression 2 256*x*x*(1-x)*(x-1)*y*(y-1)*(2*y-1)  256*y*y*(1-y)*(1-y)*x*(x-1)*(2*x-1)
                                        nom_source uex
                                        localisation FACES
                                    }
                                }
                            }
                        }
                    }
                }
            }
            # erru = euclidian_norm_norme_u_uex / euclidian_norm_norme_uex #
            erru			transformation	{
                methode formule
                expression 1 euclidian_norm_norme_u_uex/euclidian_norm_norme_uex
                sources_reference { euclidian_norm_norme_u_uex , euclidian_norm_norme_uex }
            }
            euclidian_norm_pex_elem	transformation	{
                methode formule expression 1 valeur_exacte*euclidian_norm_1
                localisation elem
                sources	{
                    transformation	{
                        methode formule
                        expression 1 1/12
                        localisation elem
                        nom_source valeur_exacte
                    } ,
                    reduction_0D	{
                        methode euclidian_norm
                        nom_source euclidian_norm_1
                        source transformation	{
                            methode formule expression 1 1
                            localisation elem
                        }
                    }
                }
            }
            euclidian_norm_p_pex_elem	reduction_0D	{
                methode euclidian_norm
                source transformation	{
                    methode formule expression 1 pelem-pmoy-pex
                    localisation elem
                    sources	{
                        interpolation	{
                            localisation elem
                            nom_source pelem
                            sources {  refChamp { Pb_champ pb pression } }
                        } ,
                        # integrale de p #
                        reduction_0D	{
                            methode moyenne
                            nom_source pmoy
                            source interpolation	{
                                localisation elem
                                source refChamp { Pb_champ pb pression }
                            }
                        } ,
                        # expression de pex #
                        transformation	{
                            methode formule
                            expression 1 (x-0.5)*(y-0.5)
                            nom_source pex
                            localisation elem
                        }
                    }
                }
            }
            errp_elem		transformation	{
                methode formule
                expression 1 euclidian_norm_p_pex_elem/euclidian_norm_pex_elem
                sources_reference { euclidian_norm_p_pex_elem , euclidian_norm_pex_elem }
            }
            # errdivu = norme L2 de la divergence de u #
            euclidian_norm_1		reduction_0D	{
                methode euclidian_norm
                source transformation	{
                    methode formule
                    expression 1 1
                    localisation elem
                }
            }
            euclidian_norm_divu		reduction_0D	{
                methode euclidian_norm
                sources	{
                    interpolation {
                        localisation elem
                        sources {
                            # divergence u #
                            divergence	{
                                source refChamp { Pb_champ pb vitesse }
                            }
                        }
                    }
                }
            }
            errdivu			transformation	{
                methode formule
                expression 1 euclidian_norm_divu/euclidian_norm_1
                localisation elem
                sources_reference { euclidian_norm_divu , euclidian_norm_1 }
            }
        }
        Sondes			{
            erru				erru		periode 5e-2 numero_elem_sur_maitre 0
            errp_elem			errp_elem	periode 5e-2 numero_elem_sur_maitre 0
            errdivu				errdivu		periode 5e-2 numero_elem_sur_maitre 0
        }
        Format lml
        Champs binaire dt_post 1e+6
        {
            pression ELEM
            vitesse elem
        }
    }
    sauvegarde formatte Cas.sauv
}

Resoudre pb
Fin

